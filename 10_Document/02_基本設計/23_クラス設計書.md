# iOSバス時刻表アプリ クラス設計書

- **バージョン:** 1.0
- **作成日:** 2025/08/22
- **アーキテクチャ:** MVVM + Serviceレイヤー

---

## 1. Model (モデル)

### ### `RouteSetting.swift`
**役割:** ユーザーが作成する一つの設定情報を表現するデータ構造です。`Codable` に準拠させて、簡単に保存できるようにします。

```swift
struct RouteSetting: Codable, Identifiable {
    // MARK: - Properties
    
    /// 各設定をユニークに識別するためのID
    var id: UUID
    
    /// ユーザーが設定する名前 (例: "パパの通勤")
    var name: String
    
    /// 「行き」のGTFSルート識別子の配列
    var outboundRouteIds: [String]
    
    /// 「帰り」のGTFSルート識別子の配列
    var inboundRouteIds: [String]
    
    /// 「行き」の接近情報ページのURL
    var outboundProximityURL: URL?
    
    /// 「帰り」の接近情報ページのURL
    var inboundProximityURL: URL?
}

### BusSchedule.swift

**役割**: GTFS-JPデータから取得した、バス1便の情報を表現するデータ構造です。

```swift
struct BusSchedule: Identifiable {
    // MARK: - Properties
    
    /// リスト表示で各項目を区別するためのID
    var id = UUID()
    
    /// HH:mm 形式の出発時刻
    var departureTime: String
    
    /// バスの路線名 (例: "鳴子14")
    var routeName: String
    
    /// バスの行き先
    var destination: String
    
    /// のりば番号
    var platform: String
}
```

### Holiday.swift

役割: 祝日APIから取得した祝日の情報を表現するデータ構造です。Codable に準拠させて、JSONから簡単に変換できるようにします。

```swift
struct Holiday: Codable {
    // MARK: - Properties
    
    /// 祝日の日付 (YYYY-MM-DD)
    var date: String // APIの形式に合わせて一旦Stringで定義
    
    /// 祝日の名前 (例: "元日")
    var name: String
}
```

## 2. Service (サービス)
### GTFSService.swift

役割: GTFS-JPデータの処理を専門に担当します。

```swift
class GTFSService {
    // MARK: - Methods
    
    /// 複数のGTFSルートから時刻表データを非同期で取得し、BusScheduleの配列を返す
    /// - Parameter routeIds: GTFSルート識別子の配列
    /// - Returns: BusScheduleの配列
    /// - Throws: データ取得エラーやCSVの解析エラー
    func fetchSchedules(from routeIds: [String]) async throws -> [BusSchedule] {
        // (ここに実際の処理を実装)
    }
}
```
### HolidayService.swift

役割: 祝日判定のロジックを専門に担当します。

```swift
class HolidayService {
    // MARK: - Properties
    
    /// 取得した祝日リストをキャッシュしておくためのプライベート変数
    private var holidays: [Holiday] = []
    
    // MARK: - Methods
    
    /// APIから祝日リストを取得し、キャッシュする
    /// - Throws: ネットワークエラーやJSONの解析エラー
    func fetchHolidays() async throws {
        // (ここに実際の処理を実装)
    }
    
    /// 指定された日付が祝日かどうかを判定する
    /// - Parameter date: 判定したい日付
    /// - Returns: 祝日の場合はtrue
    func isHoliday(date: Date) -> Bool {
        // (ここに実際の処理を実装)
    }
}
```

### PersistenceService.swift

役割: ユーザー設定の永続化（保存・読み込み）を専門に担当します。
```swift
class PersistenceService {
    // MARK: - Methods
    
    /// iPhoneのストレージから設定リストを読み込む
    /// - Returns: 保存されているRouteSettingの配列
    func loadSettings() -> [RouteSetting] {
        // (ここに実際の処理を実装)
    }
    
    /// 設定リストをiPhoneのストレージに保存する
    /// - Parameter settings: 保存したいRouteSettingの配列
    func saveSettings(_ settings: [RouteSetting]) {
        // (ここに実際の処理を実装)
    }
}
```

## 3. ViewModel (ビューモデル)
### SettingsViewModel.swift

役割: 設定画面のロジックと状態を管理します。
```swift
@MainActor
class SettingsViewModel: ObservableObject {
    // MARK: - Properties
    
    /// Viewに表示するための設定リスト。変更が自動的にUIに反映される
    @Published var routeSettings: [RouteSetting] = []
    
    /// データ永続化を担当するサービス
    private let persistenceService: PersistenceService
    
    // MARK: - Methods
    
    /// 初期化処理
    init(persistenceService: PersistenceService = PersistenceService()) {
        self.persistenceService = persistenceService
        loadSettings()
    }
    
    /// 設定リストを読み込む
    func loadSettings() {
        // (ここに実際の処理を実装)
    }
    
    /// 新しい設定を追加する
    func addSetting(_ setting: RouteSetting) {
        // (ここに実際の処理を実装)
    }
    
    /// 既存の設定を更新する
    func updateSetting(_ setting: RouteSetting) {
        // (ここに実際の処理を実装)
    }
    
    /// 設定を削除する
    func deleteSetting(at offsets: IndexSet) {
        // (ここに実際の処理を実装)
    }
}
```

### ScheduleViewModel.swift

役割: メインの時刻表画面のロジックと状態を管理します。
```swift
@MainActor
class ScheduleViewModel: ObservableObject {
    // MARK: - Properties
    
    /// Viewに表示するための時刻表リスト
    @Published var schedules: [BusSchedule] = []
    
    /// Viewに表示するための現在時刻 (HH:mm:ss形式)
    @Published var currentTime: String = "00:00:00"
    
    /// データ取得中かどうかを示すフラグ (例: ローディングインジケータ表示用)
    @Published var isLoading: Bool = false
    
    /// エラーメッセージ (例: アラート表示用)
    @Published var errorMessage: String?
    
    /// 専門的な処理を担当するサービス群
    private let gtfsService: GTFSService
    private let holidayService: HolidayService
    
    // MARK: - Methods
    
    /// 初期化処理
    init(gtfsService: GTFSService = GTFSService(), holidayService: HolidayService = HolidayService()) {
        self.gtfsService = gtfsService
        self.holidayService = holidayService
        startTimer()
    }
    
    /// 時刻表データを取得・更新するメインの処理
    /// - Parameters:
    ///   - setting: 表示対象のRouteSetting
    ///   - isOutbound: 「行き」の場合はtrue、「帰り」の場合はfalse
    func fetchSchedules(for setting: RouteSetting, isOutbound: Bool) async {
        // (ここに実際の処理を実装)
    }
    
    /// 1秒ごとに現在時刻を更新するためのタイマーを開始する
    private func startTimer() {
        // (ここに実際の処理を実装)
    }
}
```

